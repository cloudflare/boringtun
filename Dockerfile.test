# Dockerfile for BoringTun test execution with coverage
FROM rust:latest

# Install required dependencies for TUN interface, networking, and coverage tools
RUN apt-get update && apt-get install -y \
    sudo \
    iproute2 \
    iptables \
    net-tools \
    curl \
    build-essential \
    llvm \
    bc \
    docker.io \
    wireguard-tools \
    nginx \
    kmod \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-llvm-cov for coverage analysis - use compatible version
RUN cargo install cargo-llvm-cov --version 0.6.15

# Create a user with sudo privileges for testing
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create WireGuard run directory and set permissions
RUN mkdir -p /var/run/wireguard && \
    chmod 755 /var/run/wireguard

# Enable IP forwarding for routing tests
RUN echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf && \
    echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf

# Set up working directory
WORKDIR /app

# Copy the project
COPY . .

# Change ownership to testuser
RUN chown -R testuser:testuser /app

# Fix cargo permissions and install llvm tools as root first
RUN rustup component add llvm-tools-preview && \
    chmod -R 777 /usr/local/cargo

# Switch to testuser
USER testuser

# Set entrypoint to run tests
ENTRYPOINT ["/bin/bash", "/app/run-tests.sh"]
